‚úÖ Prompt para Junie:

Estoy trabajando en un sistema de registro de pacientes en Django y necesito que me ayudes a implementar una l√≥gica de creaci√≥n encadenada entre tres modelos: Paciente, IngresoPaciente y Ficha.

üîÅ L√≥gica que quiero implementar

Cuando un usuario logueado crea un nuevo Paciente, el sistema debe realizar lo siguiente autom√°ticamente, sin que el usuario intervenga:

1. Paciente

El usuario ingresa al formulario de creaci√≥n de Paciente.

El campo usuario (FK a User) se debe asignar autom√°ticamente al usuario logueado, y no se debe mostrar en el formulario.

Una vez creado el Paciente, se pasa al siguiente paso autom√°ticamente.

2. IngresoPaciente

Se debe crear un registro autom√°ticamente en IngresoPaciente despu√©s de que se crea un Paciente.

Campos que se deben completar autom√°ticamente:

paciente_id: el paciente reci√©n creado.

establecimiento_id: el establecimiento del usuario logueado (el usuario tiene un campo FK llamado establecimiento).

Restricciones:

Un paciente puede tener m√°ximo 5 ingresos en IngresoPaciente.

Cada ingreso debe ser en un establecimiento diferente.

Validar que no se cree un nuevo ingreso si ya existe uno para ese paciente en el mismo establecimiento.

3. Ficha

Luego de crear el IngresoPaciente, se debe crear autom√°ticamente un registro en Ficha.

Campos:

num_ficha: debe generarse en base al id del registro de Ficha, con ceros a la izquierda (por ejemplo: "0001", "0145", "0023").

Recomendaci√≥n: usar un campo IntegerField para guardar el n√∫mero, y aplicar el formateo visualmente (con stringformat o l√≥gica en template).

profesional_id: debe seleccionarse manualmente en el formulario (es el √∫nico campo interactivo).

usuario_id: asignar autom√°ticamente al usuario logueado.

ingreso_paciente_id: enlazar con el IngresoPaciente reci√©n creado.

üîÑ Relaci√≥n entre modelos:

Paciente ‚Üí IngresoPaciente: relaci√≥n 1 a N.

Un paciente puede tener hasta 5 ingresos, uno por cada hospital.

IngresoPaciente ‚Üí Ficha: relaci√≥n 1 a 1.

Cada ingreso tiene una ficha √∫nica.

El campo establecimiento est√° en el modelo User, por lo que al momento de crear IngresoPaciente se puede obtener con request.user.establecimiento.

üß© Requisitos t√©cnicos:

Esta l√≥gica puede implementarse en una vista basada en clases (CreateView) o mediante se√±ales (post_save) si lo prefieres.

Se debe validar:

Que no se exceda el l√≠mite de 5 ingresos por paciente.

Que no se repita un establecimiento para el mismo paciente en IngresoPaciente.

Que solo se cree una ficha por ingreso.

No se deben mostrar en el template los campos autom√°ticos (usuario, establecimiento, ingreso_paciente, etc.).

Por favor, genera el c√≥digo Django necesario para implementar esta l√≥gica, incluyendo:

Modelos (si necesitas ajustarlos),

Se√±ales o l√≥gica de vistas,

Validaciones correspondientes,

Y si es necesario, l√≥gica para formatear num_ficha.
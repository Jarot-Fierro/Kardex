{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title|default:"Historial" }}{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm card-primary card-outline mb-4 mt-5">
                    <div class="card-header">
                        <div class="row align-items-center w-100">
                            <div class="col">
                                <h5 class="mb-0">{{ title|default:"Historial" }} - {{ object }}</h5>
                            </div>
                            <div class="col-auto">
                                <a href="{% url active_url_name %}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-arrow-left"></i> Volver
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        {% if history_records %}
                            <table class="table table-hover table-striped table-bordered nowrap" style="width:100%">
                                <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Usuario</th>
                                    <th>Acción</th>
                                    <th>Cambios</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for record in history_records %}
                                    <tr>
                                        <td>{{ record.history_date }}</td>
                                        <td>{{ record.history_user|default:"Sistema" }}</td>
                                        <td>
                                            {% if record.history_type == '+' %}
                                                <span class="badge bg-success">Creación</span>
                                            {% elif record.history_type == '-' %}
                                                <span class="badge bg-danger">Eliminación</span>
                                            {% elif record.history_type == '~' %}
                                                <span class="badge bg-primary">Modificación</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if record.history_type == '~' and record.diff_against %}
                                                {% with changes=record.diff_against.changes %}
                                                    {% if changes %}
                                                        <ul class="mb-0">
                                                            {% for field, values in changes.items %}
                                                                <li>
                                                                    <strong>{{ field }}:</strong>
                                                                    {% if values.old == None %}
                                                                        Sin valor
                                                                    {% else %}
                                                                        {{ values.old }}
                                                                    {% endif %}
                                                                    →
                                                                    {% if values.new == None %}
                                                                        Sin valor
                                                                    {% else %}
                                                                        {{ values.new }}
                                                                    {% endif %}
                                                                </li>
                                                            {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        <span>No se detectaron cambios específicos</span>
                                                    {% endif %}
                                                {% endwith %}
                                            {% elif record.history_type == '+' %}
                                                <ul class="mb-0">
                                                    <li>Nombre: {{ record.name }}</li>
                                                    <li>Estado: {{ record.status }}</li>
                                                </ul>
                                            {% elif record.history_type == '-' %}
                                                <span>Registro eliminado</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <div class="alert alert-info">
                                No hay registros de historial para este elemento.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
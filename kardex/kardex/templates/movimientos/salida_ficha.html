{% extends 'base.html' %}
{% load static %}

{% block title %}Salida de Fichas{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">Filtros</h3>
      </div>
      <div class="card-body">
        <form id="form-filtros" class="form" method="get">
          <div class="form-row">
            <div class="form-group col-md-3">
              <label>Inicio</label>
              <input type="datetime-local" class="form-control" name="inicio" value="{{ request.GET.inicio }}">
            </div>
            <div class="form-group col-md-3">
              <label>Término</label>
              <input type="datetime-local" class="form-control" name="termino" value="{{ request.GET.termino }}">
            </div>
            <div class="form-group col-md-3">
              <label>Servicio Clínico</label>
              <select class="form-control" name="servicio">
                <option value="">Todos</option>
                {% for sc in servicio_clinicos %}
                  <option value="{{ sc.id }}">{{ sc.nombre }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Profesional</label>
              <input type="text" class="form-control" name="profesional" value="{{ request.GET.profesional }}" placeholder="ID profesional">
            </div>
          </div>
          <button class="btn btn-secondary" type="submit"><i class="fas fa-filter"></i> Aplicar filtros</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">Registrar Salida de Ficha</h3>
      </div>
      <div class="card-body">
        <form id="form-salida" class="form" onsubmit="return false;">
          <div class="form-row">
            <div class="form-group col-md-3">
              <label>RUT</label>
              <input type="text" class="form-control" id="rut" placeholder="Ingrese RUT">
            </div>
            <div class="form-group col-md-3">
              <label>N° Ficha</label>
              <input type="text" class="form-control" id="ficha" placeholder="Ingrese N° Ficha">
            </div>
            <div class="form-group col-md-6">
              <label>Nombres</label>
              <input type="text" class="form-control" id="nombres" readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Servicio Clínico</label>
              <select class="form-control" id="servicio_clinico">
                <option value="">Seleccione...</option>
                {% for sc in servicio_clinicos %}
                  <option value="{{ sc.id }}">{{ sc.nombre }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-4">
              <label>Profesional</label>
              <select class="form-control" id="profesional">
                <option value="{{ request.user.id }}" selected>{{ request.user.username }}</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label>Fecha de salida</label>
              <input type="datetime-local" class="form-control" id="fecha">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-12">
              <label>Observación de salida</label>
              <textarea id="observacion" class="form-control" rows="2"></textarea>
            </div>
          </div>
          <button type="button" id="btn-registrar-salida" class="btn btn-primary"><i class="fas fa-save"></i> Registrar salida</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Movimientos (establecimiento actual)</h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="tabla-mov" class="table table-striped table-hover table-sm" style="width:100%">
            <thead>
            <tr>
              {% for c in view.datatable_columns %}
                <th>{{ c }}</th>
              {% endfor %}
              <th></th>
            </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'adminlte3/plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'adminlte3/plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'adminlte3/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'js/movimientos/autocompletar_ficha.js' %}"></script>
<script>
  $(function(){
    // init datatable (respect filters)
    function getAjaxData(){
      const params = new URLSearchParams(window.location.search);
      const data = { datatable: 1 };
      for (const [k,v] of params.entries()) { data[k] = v; }
      return data;
    }
    const table = $('#tabla-mov').DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: window.location.pathname + window.location.search,
        data: function(){ return getAjaxData(); },
        dataSrc: 'data'
      },
      columns: [
        {% for c in view.datatable_columns %}{ data: '{{ c }}' },{% endfor %}
        { data: 'actions', orderable: false, searchable: false },
      ]
    });

    // Registrar salida
    $('#btn-registrar-salida').on('click', function(){
      $.post(window.location.href, {
        action: 'salida',
        rut: $('#rut').val(),
        ficha: $('#ficha').val(),
        servicio_clinico: $('#servicio_clinico').val(),
        profesional: $('#profesional').val(),
        fecha: $('#fecha').val().replace('T',' '),
        observacion: $('#observacion').val(),
        csrfmiddlewaretoken: '{{ csrf_token }}'
      }).done(function(resp){
        if(resp.ok){
          toastr.success('Salida registrada');
          table.ajax.reload(null, false);
        } else {
          toastr.error(resp.error || 'Error al registrar');
        }
      }).fail(function(xhr){
        const msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : 'Error de comunicación';
        toastr.error(msg);
      });
    });

    // Autocompletar por RUT / Ficha
    initAutocompletarFicha('#rut', '#ficha', '#nombres');
    initAutocompletarFichaByFicha('#ficha', '#rut', '#nombres');
  });
</script>
{% endblock %}

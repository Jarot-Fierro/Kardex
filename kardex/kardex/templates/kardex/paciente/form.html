{% extends 'base.html' %}
{% load static %}

{% block title %}Pacientes - {{ title|default:'Formulario' }}{% endblock %}

{% block content %}
<style>
    /* Compact, print-friendly adjustments */
    .small-input .form-control,
    .small-input .form-select {
        font-size: .875rem;
        padding: .25rem .5rem;
        height: calc(1.5em + .5rem + 2px);
    }

    .small-input .form-label,
    .small-input label {
        margin-bottom: .1rem;
        font-size: .85rem;
    }

    .small-input .form-text,
    .small-input .small {
        font-size: .75rem;
    }

    .small-input .card-header {
        padding: .4rem .75rem;
    }

    .small-input .card-body {
        padding: .75rem;
    }

    .small-input .form-check {
        padding-top: .15rem;
    }

    .small-input .form-check-input {
        transform: scale(.9);
        margin-right: .35rem;
    }

    .small-input .btn {
        padding: .25rem .5rem;
        font-size: .875rem;
    }

    .card {
        border-color: #e9ecef;
    }

    .ficha-header {
        border: 1px solid #dee2e6;
        border-left: .25rem solid #0d6efd;
        padding: .35rem .5rem;
        background-color: #f8f9fa;
        font-weight: 600;
    }

    @media print {
        .no-print {
            display: none !important;
        }

        .card {
            box-shadow: none;
        }

        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }
</style>
<div class="container-fluid py-2 small-input">
    <form method="post" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}
        <input type="hidden" name="action" id="form_action_hidden" value="{{ action|default:'add' }}">
        <input type="hidden" name="paciente_id" id="paciente_id_hidden" value="{{ paciente.id|default:'' }}">

        <!-- Encabezado de la ficha -->
        <div class="row align-items-center mb-2">
            <div class="col-md-6 mb-2 mb-md-0">
                <div class="ficha-header d-flex justify-content-between align-items-center">
                    <span>N° FICHA:
                        <input type="text" value='{{ ficha.numero_ficha|stringformat:"04d" }}' name="ficha"
                               class="form-control" placeholder="N° Ficha" id="id_numero_ficha">
                    </span>
                    <div class="text-muted small">
                        <div>
                            F. creación: <span id="ficha_created_at_text">
                                {{ ficha.created_at|date:"d/m/Y"|default:"-" }}</span><br>
                            F. modificación: <span id="ficha_updated_at_text">
                                {{ ficha.updated_at|date:"d/m/Y"|default:"-" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 text-md-end">
                <input type="text" value="{{ paciente.codigo|default:'' }}" name="codigo" class="form-control"
                       placeholder="Código" id="id_código">
            </div>

            <div class="col-md-3 text-md-end">
                <div class="btn-group w-100 no-print" role="group" aria-label="Impresión">
                    <a class="btn btn-outline-secondary btn-sm w-50"
                       href="{% url 'kardex:pdf_paciente' paciente_id=paciente.id %}" target="_blank"
                       rel="noopener noreferrer">
                        Carátula
                    </a>
                    <button class="btn btn-outline-secondary btn-sm w-50" type="button">Imprimir Etiqueta 2</button>
                </div>
            </div>


        </div>

        <!-- ESTADO DEL PACIENTE -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-heartbeat me-2"></i> Estado del Paciente</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <!-- Checkbox 1 -->
                    <div class="col-md-4">
                        <div class="form-check mt-2">
                            {{ form.recien_nacido }}
                            <label class="form-check-label" for="recien_nacido_paciente">
                                {{ form.recien_nacido.label }}
                            </label>
                            {% for error in form.recien_nacido.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Checkbox 2 -->
                    <div class="col-md-4">
                        <div class="form-check mt-2">
                            {{ form.extranjero }}
                            <label class="form-check-label" for="extranjero_paciente">
                                {{ form.extranjero.label }}
                            </label>
                            {% for error in form.extranjero.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Checkbox 3 + input date -->
                    <div class="col-md-4">
                        <div class="form-check mt-2">
                            {{ form.fallecido }}
                            <label class="form-check-label" for="fallecido_paciente">
                                {{ form.fallecido.label }}
                            </label>
                            {% for error in form.fallecido.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>

                        <!-- Input de fecha debajo del checkbox fallecido -->
                        <div class="mt-2">
                            <label class="form-label" for="fecha_fallecimiento_paciente">
                                {{ form.fecha_fallecimiento.label }}
                            </label>
                            {{ form.fecha_fallecimiento }}
                            {% for error in form.fecha_fallecimiento.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <!-- IDENTIFICACIÓN -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-id-card me-2"></i> Identificación</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label" for="id_rut">
                            {{ form.rut.label }}
                        </label>
                        {{ form.rut }}
                        {% for error in form.rut.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="pasaporte_paciente">
                            {{ form.pasaporte.label }}
                        </label>
                        {{ form.pasaporte }}
                        {% for error in form.pasaporte.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nie_paciente">
                            {{ form.nie.label }}
                        </label>
                        {{ form.nie }}
                        {% for error in form.nie.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombre_paciente">
                            {{ form.nombre.label }}
                        </label>
                        {{ form.nombre }}
                        {% for error in form.nombre.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombre_social_paciente">
                            {{ form.nombre_social.label }}
                        </label>
                        {{ form.nombre_social }}
                        {% for error in form.nombre_social.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="apellido_paterno_paciente">
                            {{ form.apellido_paterno.label }}
                        </label>
                        {{ form.apellido_paterno }}
                        {% for error in form.apellido_paterno.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="apellido_materno_paciente">
                            {{ form.apellido_materno.label }}
                        </label>
                        {{ form.apellido_materno }}
                        {% for error in form.apellido_materno.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- DATOS DE NACIMIENTO -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-baby me-2"></i> Datos de Nacimiento</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label" for="fecha_nacimiento_paciente">
                            {{ form.fecha_nacimiento.label }}</label>
                        {{ form.fecha_nacimiento }}
                        {% for error in form.fecha_nacimiento.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="sexo_paciente">{{ form.sexo.label }}</label>
                        {{ form.sexo }}
                        {% for error in form.sexo.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="estado_civil_paciente">{{ form.estado_civil.label }}</label>
                        {{ form.estado_civil }}
                        {% for error in form.estado_civil.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- DATOS FAMILIARES -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-users me-2"></i> Datos Familiares</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label" for="id_rut">{{ form.rut_madre.label }}</label>
                        {{ form.rut_madre }}
                        {% for error in form.rut_madre.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombres_madre_paciente">{{ form.nombres_madre.label }}</label>
                        {{ form.nombres_madre }}
                        {% for error in form.nombres_madre.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombres_padre_paciente">{{ form.nombres_padre.label }}</label>
                        {{ form.nombres_padre }}
                        {% for error in form.nombres_padre.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombre_pareja_paciente">{{ form.nombre_pareja.label }}</label>
                        {{ form.nombre_pareja }}
                        {% for error in form.nombre_pareja.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="rut_responsable_temporal_paciente">
                            {{ form.rut_responsable_temporal.label }}
                        </label>
                        {{ form.rut_responsable_temporal }}
                        {% for error in form.rut_responsable_temporal.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mt-2">
                            {{ form.usar_rut_madre_como_responsable }}
                            <label class="form-check-label" for="usar_rut_madre_como_responsable_paciente">
                                {{ form.usar_rut_madre_como_responsable.label }}
                            </label>
                            {% for error in form.usar_rut_madre_como_responsable.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="representante_legal_paciente">
                            {{ form.representante_legal.label }}
                        </label>
                        {{ form.representante_legal }}
                        {% for error in form.representante_legal.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTACTO Y DIRECCIÓN -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-map-marker-alt me-2"></i> Contacto y Dirección</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-8">
                        <label class="form-label" for="direccion_paciente">{{ form.direccion.label }}</label>
                        {{ form.direccion }}
                        {% for error in form.direccion.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="comuna_paciente">{{ form.comuna.label }}</label>
                        {{ form.comuna }}
                        {% for error in form.comuna.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="numero_telefono1_paciente">
                            {{ form.numero_telefono1.label }}</label>
                        {{ form.numero_telefono1 }}
                        {% for error in form.numero_telefono1.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="numero_telefono2_paciente">
                            {{ form.numero_telefono2.label }}</label>
                        {{ form.numero_telefono2 }}
                        {% for error in form.numero_telefono2.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="ocupacion_paciente">{{ form.ocupacion.label }}</label>
                        {{ form.ocupacion }}
                        {% for error in form.ocupacion.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- GESTIÓN -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-cogs me-2"></i> Gestión</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label" for="prevision_paciente">{{ form.prevision.label }}</label>
                        {{ form.prevision }}
                        {% for error in form.prevision.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6 d-none">
                        <label class="form-label" for="usuario_paciente">{{ form.usuario.label }}</label>
                        {{ form.usuario }}
                        {% for error in form.usuario.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Pie del formulario -->
        <div class="row mt-3 mb-4">
            <div class="col text-end">

                <a href="{% url 'kardex:paciente_list' %}" class="btn btn-secondary btn-sm no-print">Cancelar</a>
                <button type="submit" class="btn btn-primary btn-sm no-print">Guardar</button>
            </div>
        </div>
    </form>
</div>
<script>
    (function () {
        function qs(sel) { return document.querySelector(sel); }
        function qid(id) { return document.getElementById(id); }
        const el = {
            rut: qid('id_rut'),
            nie: qid('nie_paciente'),
            pasaporte: qid('pasaporte_paciente'),
            ocupacion: qid('ocupacion_paciente'),
            nombre_pareja: qid('nombre_pareja_paciente'),
            rut_resp_temp: qid('rut_responsable_temporal_paciente'),
            usar_rut_madre: qid('usar_rut_madre_como_responsable_paciente'),
            rut_madre: qid('id_rut_madre'),
            recien_nacido: qid('recien_nacido_paciente'),
            extranjero: qid('extranjero_paciente'),
            fallecido: qid('fallecido_paciente'),
            fecha_fallecimiento: qid('fecha_fallecimiento_paciente'),
        };

        function setDisabled(inputs, disabled) {
            inputs.filter(Boolean).forEach(i => {
                i.disabled = !!disabled;
                if (disabled) {
                    if (i.type === 'checkbox' || i.type === 'radio') { i.checked = false; }
                    else { i.value = ''; }
                    i.removeAttribute('required');
                }
            });
        }
        function setEnabled(inputs) {
            inputs.filter(Boolean).forEach(i => { i.disabled = false; });
        }
        function setRequired(inputs, required) {
            inputs.filter(Boolean).forEach(i => {
                if (required) i.setAttribute('required', 'required'); else i.removeAttribute('required');
            });
        }

        function applyRules() {
            const rn = !!(el.recien_nacido && el.recien_nacido.checked);
            const ext = !!(el.extranjero && el.extranjero.checked);
            const fal = !!(el.fallecido && el.fallecido.checked);

            // Reset defaults: enable general fields
            setEnabled([el.rut, el.pasaporte, el.nie, el.ocupacion, el.nombre_pareja, el.rut_resp_temp, el.usar_rut_madre, el.fecha_fallecimiento]);

            // Clear required by default
            setRequired([el.rut, el.pasaporte, el.nie, el.fecha_fallecimiento, el.rut_resp_temp], false);

            if (!rn && !ext && !fal) {
                // Estándar, sin fallecimiento
                setEnabled([el.ocupacion, el.nombre_pareja]);
                setDisabled([el.nie, el.pasaporte, el.rut_resp_temp, el.usar_rut_madre, el.fecha_fallecimiento], true);
                setRequired([el.rut], true);
            }

            if (!rn && !ext && fal) {
                // Fallecido solo
                setEnabled([el.fecha_fallecimiento]);
                setDisabled([el.nie, el.pasaporte, el.rut_resp_temp, el.usar_rut_madre], true);
                setRequired([el.fecha_fallecimiento], true);
                setRequired([el.rut], true);
            }

            if (rn && !ext && !fal) {
                // Recien nacido solo
                setEnabled([el.rut_resp_temp, el.usar_rut_madre]);
                setDisabled([el.nie, el.pasaporte, el.ocupacion, el.nombre_pareja, el.fecha_fallecimiento], true);
                setRequired([el.rut_resp_temp], true);
                setRequired([el.rut_madre], true);
                setRequired([el.rut], false);
            }

            if (rn && !ext && fal) {
                // Recien nacido + Fallecido
                setEnabled([el.fecha_fallecimiento, el.rut_resp_temp, el.usar_rut_madre]);
                setDisabled([el.nombre_pareja, el.nie, el.pasaporte, el.ocupacion], true);
                setRequired([el.fecha_fallecimiento], true);
                setRequired([el.rut_resp_temp], false);
                setRequired([el.rut_madre], true);
                setRequired([el.rut], false);
            }

            if (!rn && ext && !fal) {
                // Extranjero solo
                setEnabled([el.nie, el.pasaporte]);
                setDisabled([el.rut_resp_temp, el.usar_rut_madre, el.ocupacion, el.fecha_fallecimiento], true);
                setRequired([el.nie, el.pasaporte], false);
                setRequired([el.rut], false);
            }

            if (!rn && ext && fal) {
                // Extranjero + Fallecido
                setEnabled([el.fecha_fallecimiento, el.nie, el.pasaporte, el.nombre_pareja]);
                setDisabled([el.rut_resp_temp, el.usar_rut_madre, el.ocupacion], true);
                setRequired([el.fecha_fallecimiento], true);
                setRequired([el.rut_resp_temp, el.rut], false);
            }

            if (rn && ext && !fal) {
                // Recien nacido + Extranjero (sin fallecer)
                setEnabled([el.nie, el.pasaporte, el.rut_resp_temp, el.usar_rut_madre]);
                setDisabled([el.nombre_pareja, el.ocupacion, el.fecha_fallecimiento], true);
                setRequired([el.rut_resp_temp], true);
                setRequired([el.rut_madre], true);
                setRequired([el.rut], false);
            }

            if (rn && ext && fal) {
                // Recien nacido + Extranjero + Fallecido
                setEnabled([el.fecha_fallecimiento, el.rut_resp_temp, el.usar_rut_madre, el.nie, el.pasaporte]);
                setDisabled([el.nombre_pareja, el.ocupacion], true);
                setRequired([el.fecha_fallecimiento], true);
                setRequired([el.rut_madre], true);
                setRequired([el.rut_resp_temp], false);
                setRequired([el.rut], false);
            }
        }

        function onSubmit(e) {
            const rn = el.recien_nacido && el.recien_nacido.checked;
            const ext = el.extranjero && el.extranjero.checked;
            const fal = el.fallecido && el.fallecido.checked;

            // Fallecido requires fecha_fallecimiento
            if (fal) {
                if (el.fecha_fallecimiento && !el.fecha_fallecimiento.value) {
                    e.preventDefault();
                    alert('Debe ingresar la fecha de fallecimiento.');
                    el.fecha_fallecimiento.focus();
                    return false;
                }
            }

            if (rn) {
                // Validate responsable: either rut_responsable_temporal or usar_rut_madre checked
                const hasTemp = el.rut_resp_temp && el.rut_resp_temp.value.trim() !== '';
                const useMadre = el.usar_rut_madre && el.usar_rut_madre.checked;
                if (!hasTemp && !useMadre) {
                    e.preventDefault();
                    alert('Debe ingresar RUT responsable temporal o activar "Usar RUT de la madre como responsable".');
                    if (el.rut_resp_temp) el.rut_resp_temp.focus();
                    return false;
                }
            }

            if (!rn && ext) {
                const hasNie = el.nie && el.nie.value.trim() !== '';
                const hasPas = el.pasaporte && el.pasaporte.value.trim() !== '';
                if (!hasNie && !hasPas) {
                    e.preventDefault();
                    alert('Para pacientes extranjeros, debe ingresar al menos NIE o Pasaporte.');
                    if (el.nie) el.nie.focus();
                    return false;
                }
            }

            if (!rn && !ext && !fal) {
                if (el.rut && el.rut.value.trim() === '') {
                    e.preventDefault();
                    alert('El campo RUT es obligatorio para pacientes estándar.');
                    el.rut.focus();
                    return false;
                }
            }
        }

        document.addEventListener('change', function (ev) {
            if (!ev.target) return;
            const id = ev.target.id;
            if (['recien_nacido_paciente', 'extranjero_paciente', 'fallecido_paciente'].includes(id)) {
                applyRules();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            applyRules();
            // Attach submit validation
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', onSubmit);
            }
        });
        // Expose rules applier for other scripts (e.g., AJAX fill)
        window._pacienteApplyRules = applyRules;
    })();
</script>
<script>
    (function () {
        function q(id) { return document.getElementById(id); }
        function selAll(selector) { return Array.prototype.slice.call(document.querySelectorAll(selector)); }
        const urlRut = '{% url "kardex:api_buscar_paciente_por_rut" %}';
        const urlCod = '{% url "kardex:api_buscar_paciente_por_codigo" %}';
        const urlFicha = '{% url "kardex:api_buscar_paciente_por_ficha" %}';

        const inputRut = q('id_rut');
        const inputCodigo = q('id_código');
        const inputNumFicha = q('id_numero_ficha');

        const campoNombre = q('nombre_paciente');
        const campoApPat = q('apellido_paterno_paciente');
        const campoApMat = q('apellido_materno_paciente');
        const campoFechaNac = q('fecha_nacimiento_paciente');
        // Spans para fechas dinámicas
        const spanPacCreated = q('paciente_created_at_text');
        const spanPacUpdated = q('paciente_updated_at_text');
        const spanFichaCreated = q('ficha_created_at_text');
        const spanFichaUpdated = q('ficha_updated_at_text');

        function lockForm(lock) {
            const form = document.querySelector('form');
            if (!form) return;
            const elems = form.querySelectorAll('input, select, textarea, button');
            elems.forEach(el => {
                if (lock) { el.setAttribute('data-prev-disabled', el.disabled ? '1' : '0'); el.disabled = true; }
                else { /* no-op on unlock here; we will force-enable below */ el.removeAttribute('data-prev-disabled'); }
            });
        }
        function enableAllInputs() {
            const form = document.querySelector('form');
            if (!form) return;
            form.querySelectorAll('input, select, textarea, button').forEach(el => { el.disabled = false; });
        }

        function isoToDMY(iso) {
            // iso expected YYYY-MM-DD
            if (!iso) return '';
            const p = iso.split('-');
            if (p.length !== 3) return iso;
            return `${p[2]}/${p[1]}/${p[0]}`;
        }
        function isoToDMYHM(iso) {
            // expects ISO datetime or date; returns dd/mm/yyyy HH:MM
            if (!iso) return '';
            try {
                const d = new Date(iso);
                if (isNaN(d.getTime())) return iso;
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                const hh = String(d.getHours()).padStart(2, '0');
                const mi = String(d.getMinutes()).padStart(2, '0');
                return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
            } catch (e) {
                return iso;
            }
        }

        function fillForm(p) {
            if (!p) return;

            // Set hidden paciente id and switch form action to edit
            const hiddenId = document.getElementById('paciente_id_hidden');
            if (hiddenId) hiddenId.value = p.id || '';
            const hiddenAction = document.getElementById('form_action_hidden');
            if (hiddenAction && p.id) hiddenAction.value = 'edit';

            if (inputRut) inputRut.value = p.rut || '';
            if (inputCodigo) inputCodigo.value = p.codigo || '';
            if (campoNombre) campoNombre.value = p.nombre || '';
            if (campoApPat) campoApPat.value = p.apellido_paterno || '';
            if (campoApMat) campoApMat.value = p.apellido_materno || '';
            if (campoFechaNac) campoFechaNac.value = p.fecha_nacimiento;
            if (inputNumFicha) inputNumFicha.value = p.numero_ficha || '';

            // Nuevos campos
            const nie = document.getElementById('nie_paciente');
            if (nie) nie.value = p.nie || '';

            const pasaporte = document.getElementById('pasaporte_paciente');
            if (pasaporte) pasaporte.value = p.pasaporte || '';

            const rutMadre = document.getElementById('id_rut_madre');
            if (rutMadre) rutMadre.value = p.rut_madre || '';

            const FechaNacimiento = document.getElementById('id_fecha_nacimiento');
            if (FechaNacimiento) FechaNacimiento.value = p.fecha_nacimiento || '';

            const responsableTemp = document.getElementById('rut_responsable_temporal_paciente');
            if (responsableTemp) responsableTemp.value = p.rut_responsable_temporal || '';

            const nombrePareja = document.getElementById('nombre_pareja_paciente');
            if (nombrePareja) nombrePareja.value = p.nombre_pareja || '';

            const ocupacion = document.getElementById('ocupacion_paciente');
            if (ocupacion) ocupacion.value = p.ocupacion || '';

            const direccion = document.getElementById('direccion_paciente');
            if (direccion) direccion.value = p.direccion || '';

            const telefono1 = document.getElementById('numero_telefono1_paciente');
            if (telefono1) telefono1.value = p.numero_telefono1 || '';

            const telefono2 = document.getElementById('numero_telefono2_paciente');
            if (telefono2) telefono2.value = p.numero_telefono2 || '';

            const fechaFallecimiento = document.getElementById('fecha_fallecimiento_paciente');
            if (fechaFallecimiento) fechaFallecimiento.value = p.fecha_fallecimiento || '';

            const comuna = document.getElementById('comuna_paciente');
            if (comuna) { comuna.value = p.comuna || ''; comuna.dispatchEvent(new Event('change')); }

            const prevision = document.getElementById('prevision_paciente');
            if (prevision) { prevision.value = p.prevision || ''; prevision.dispatchEvent(new Event('change')); }

            const usarRutMadre = document.getElementById('usar_rut_madre_como_responsable_paciente');
            if (usarRutMadre) usarRutMadre.checked = !!p.usar_rut_madre_como_responsable;

            const recienNacido = document.getElementById('recien_nacido_paciente');
            if (recienNacido) {
                recienNacido.checked = !!p.recien_nacido;
                recienNacido.dispatchEvent(new Event('change'));
            }

            const extranjero = document.getElementById('extranjero_paciente');
            if (extranjero) {
                extranjero.checked = !!p.extranjero;
                extranjero.dispatchEvent(new Event('change'));
            }

            const fallecido = document.getElementById('fallecido_paciente');
            if (fallecido) {
                fallecido.checked = !!p.fallecido;
                fallecido.dispatchEvent(new Event('change'));
            }

            // Fechas de auditoría
            if (spanPacCreated) spanPacCreated.textContent = isoToDMYHM(p.paciente_created_at);
            if (spanPacUpdated) spanPacUpdated.textContent = isoToDMYHM(p.paciente_updated_at);
            if (spanFichaCreated) spanFichaCreated.textContent = isoToDMYHM(p.ficha_created_at);
            if (spanFichaUpdated) spanFichaUpdated.textContent = isoToDMYHM(p.ficha_updated_at);
        }



        async function doSearch(endpoint, paramName, value) {
            if (!value) return;
            const url = new URL(endpoint, window.location.origin);
            url.searchParams.set(paramName, value);
            try {
                lockForm(true);
                const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                const data = await resp.json();
                if (data && data.success) {
                    fillForm(data.paciente);
                } else {
                    const msg = (data && (data.error || data.message)) || 'No se encontró el paciente.';
                    alert(msg);
                }
            } catch (e) {
                console.error(e);
                alert('Ocurrió un error realizando la búsqueda.');
            } finally {
                lockForm(false);
                enableAllInputs();
                // Ensure rules are applied after programmatic changes from AJAX
                if (window._pacienteApplyRules) { window._pacienteApplyRules(); }
            }
        }

        function attach() {
            if (inputRut) {
                inputRut.addEventListener('blur', function () {
                    const v = (this.value || '').trim();
                    if (v) doSearch(urlRut, 'rut', v);
                });
                inputRut.addEventListener('change', function () {
                    const v = (this.value || '').trim();
                    if (v) doSearch(urlRut, 'rut', v);
                });
            }
            if (inputCodigo) {
                inputCodigo.addEventListener('blur', function () {
                    const v = (this.value || '').trim();
                    if (v) doSearch(urlCod, 'codigo', v);
                });
                inputCodigo.addEventListener('change', function () {
                    const v = (this.value || '').trim();
                    if (v) doSearch(urlCod, 'codigo', v);
                });
            }
            if (inputNumFicha) {
                inputNumFicha.addEventListener('blur', function () {
                    const v = (this.value || '').trim();
                    if (v) doSearch(urlFicha, 'numero_ficha', v);
                });
                inputNumFicha.addEventListener('change', function () {
                    const v = (this.value || '').trim();
                    if (v) doSearch(urlFicha, 'numero_ficha', v);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', attach);
    })();
</script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}Pacientes - {{ title|default:'Formulario' }}{% endblock %}

{% block content %}

<div class="container-fluid py-2 small-input">
    <form method="post" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}
        <input type="hidden" name="action" id="form_action_hidden" value="{{ action|default:'add' }}">
        <input type="hidden" name="paciente_id" id="paciente_id_hidden" value="{{ paciente.id|default:'' }}">
        <input type="hidden" name="ficha_id" id="ficha_id_hidden" value="{{ ficha.id|default:'' }}">

        <!-- Encabezado de la ficha -->
        <div class="row align-items-center mb-2">
            <div class="col-md-6 mb-2 mb-md-0">
                <div class="ficha-header align-items-center">
                    <div class="row">
                        <div class="col-7">
                            <span>N° FICHA:</span><br>
                            <select name="ficha" class="form-control select2-ajax" placeholder="N° Ficha" id="id_ficha"
                                    style="min-width: 100px;">
                            </select>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">
                                <div>
                                    F. creación: <span id="ficha_created_at_text">...</span><br>
                                    F. modificación: <span id="ficha_updated_at_text">...</span>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 text-md-end">
                <select value="{{ paciente.codigo|default:'' }}" name="codigo" class="form-control"
                        placeholder="Código" id="id_codigo">
                </select>
                <input type="hidden" id="codigo_inicial" value="{{ paciente.codigo }}">
            </div>

            <div class="col-md-3 text-md-end">
                <div class="btn-group w-100 no-print" role="group" aria-label="Impresión">
                    <a id="btn-caratula" class="btn btn-outline-secondary btn-sm w-50 disabled" href="#" target="_blank"
                       aria-disabled="true" rel="noopener noreferrer">Carátula</a>
                    <a id="btn-stickers" class="btn btn-outline-secondary btn-sm w-50 disabled" href="#" target="_blank"
                       aria-disabled="true" rel="noopener noreferrer">Stickers</a>
                </div>
            </div>


        </div>

        <!-- ESTADO DEL PACIENTE -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-heartbeat me-2"></i> Estado del Paciente</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <!-- Checkbox 1 -->
                    <div class="col-md-3">
                        <div class="form-check mt-2">
                            {{ form.recien_nacido }}
                            <label class="form-check-label" for="recien_nacido_paciente">
                                {{ form.recien_nacido.label }}
                            </label>
                            {% for error in form.recien_nacido.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Checkbox 2 -->
                    <div class="col-md-3">
                        <div class="form-check mt-2">
                            {{ form.extranjero }}
                            <label class="form-check-label" for="extranjero_paciente">
                                {{ form.extranjero.label }}
                            </label>
                            {% for error in form.extranjero.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <!-- Checkbox 2 -->
                    <div class="col-md-3">
                        <div class="form-check mt-2">
                            {{ form.pueblo_indigena }}
                            <label class="form-check-label" for="pueblo_indigena_paciente">
                                {{ form.pueblo_indigena.label }}
                            </label>
                            {% for error in form.pueblo_indigena.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Checkbox 3 + input date -->
                    <div class="col-md-3">
                        <div class="form-check mt-2">
                            {{ form.fallecido }}
                            <label class="form-check-label" for="fallecido_paciente">
                                {{ form.fallecido.label }}
                            </label>
                            {% for error in form.fallecido.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>

                        <!-- Input de fecha debajo del checkbox fallecido -->
                        <div class="mt-2">
                            <label class="form-label" for="fecha_fallecimiento_paciente">
                                {{ form.fecha_fallecimiento.label }}
                            </label>
                            {{ form.fecha_fallecimiento }}
                            {% for error in form.fecha_fallecimiento.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <!-- IDENTIFICACIÓN -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-id-card me-2"></i> Identificación</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label" for="id_rut">
                            {{ form.rut.label }}
                        </label>

                        <!-- Input con botón integrado -->
                        <div class="input-group">
                            {{ form.rut }}

                            <!-- Botón tipo etiqueta dentro del input -->
                            <div class="input-group-append">
                                <a href="{% url 'kardex:paciente_actualizar_rut' paciente.pk %}"
                                   class="btn btn-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Input hidden con valor inicial -->
                        <input type="hidden" id="rut_inicial" value="{{ paciente.rut|default:'' }}">

                        {% for error in form.rut.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <div class="col-md-6">
                        <label class="form-label" for="pasaporte_paciente">
                            {{ form.pasaporte.label }}
                        </label>
                        {{ form.pasaporte }}
                        {% for error in form.pasaporte.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nie_paciente">
                            {{ form.nie.label }}
                        </label>
                        {{ form.nie }}
                        {% for error in form.nie.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombre_paciente">
                            {{ form.nombre.label }}
                        </label>
                        {{ form.nombre }}
                        {% for error in form.nombre.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombre_social_paciente">
                            {{ form.nombre_social.label }}
                        </label>
                        {{ form.nombre_social }}
                        {% for error in form.nombre_social.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="apellido_paterno_paciente">
                            {{ form.apellido_paterno.label }}
                        </label>
                        {{ form.apellido_paterno }}
                        {% for error in form.apellido_paterno.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="apellido_materno_paciente">
                            {{ form.apellido_materno.label }}
                        </label>
                        {{ form.apellido_materno }}
                        {% for error in form.apellido_materno.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- DATOS DE NACIMIENTO -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-baby me-2"></i> Datos de Nacimiento</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label" for="fecha_nacimiento_paciente">
                            {{ form.fecha_nacimiento.label }}</label>
                        {{ form.fecha_nacimiento }}
                        {% for error in form.fecha_nacimiento.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="sexo_paciente">{{ form.sexo.label }}</label>
                        {{ form.sexo }}
                        {% for error in form.sexo.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="estado_civil_paciente">{{ form.estado_civil.label }}</label>
                        {{ form.estado_civil }}
                        {% for error in form.estado_civil.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- DATOS FAMILIARES -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-users me-2"></i> Datos Familiares</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label" for="id_rut">{{ form.rut_madre.label }}</label>
                        {{ form.rut_madre }}
                        {% for error in form.rut_madre.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombres_madre_paciente">{{ form.nombres_madre.label }}</label>
                        {{ form.nombres_madre }}
                        {% for error in form.nombres_madre.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombres_padre_paciente">{{ form.nombres_padre.label }}</label>
                        {{ form.nombres_padre }}
                        {% for error in form.nombres_padre.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="nombre_pareja_paciente">{{ form.nombre_pareja.label }}</label>
                        {{ form.nombre_pareja }}
                        {% for error in form.nombre_pareja.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="rut_responsable_temporal_paciente">
                            {{ form.rut_responsable_temporal.label }}
                        </label>
                        {{ form.rut_responsable_temporal }}
                        {% for error in form.rut_responsable_temporal.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mt-2">
                            {{ form.usar_rut_madre_como_responsable }}
                            <label class="form-check-label" for="usar_rut_madre_como_responsable_paciente">
                                {{ form.usar_rut_madre_como_responsable.label }}
                            </label>
                            {% for error in form.usar_rut_madre_como_responsable.errors %}
                            <span class="text-danger small d-block">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="representante_legal_paciente">
                            {{ form.representante_legal.label }}
                        </label>
                        {{ form.representante_legal }}
                        {% for error in form.representante_legal.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTACTO Y DIRECCIÓN -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-map-marker-alt me-2"></i> Contacto y Dirección</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-8">
                        <label class="form-label" for="direccion_paciente">{{ form.direccion.label }}</label>
                        {{ form.direccion }}
                        {% for error in form.direccion.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="comuna_paciente">{{ form.comuna.label }}</label>
                        {{ form.comuna }}
                        {% for error in form.comuna.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="numero_telefono1_paciente">
                            {{ form.numero_telefono1.label }}</label>
                        {{ form.numero_telefono1 }}
                        {% for error in form.numero_telefono1.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="numero_telefono2_paciente">
                            {{ form.numero_telefono2.label }}</label>
                        {{ form.numero_telefono2 }}
                        {% for error in form.numero_telefono2.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="ocupacion_paciente">{{ form.ocupacion.label }}</label>
                        {{ form.ocupacion }}
                        {% for error in form.ocupacion.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- GESTIÓN -->
        <div class="card mb-2">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-cogs me-2"></i> Gestión</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label" for="prevision_paciente">{{ form.prevision.label }}</label>
                        {{ form.prevision }}
                        {% for error in form.prevision.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="sector_paciente">{{ form.sector.label }}</label>
                        {{ form.sector }}
                        {% for error in form.sector.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6 d-none">
                        <label class="form-label" for="usuario_paciente">{{ form.usuario.label }}</label>
                        {{ form.usuario }}
                        {% for error in form.usuario.errors %}
                        <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Pie del formulario -->
        <div class="row mt-3 mb-4">
            <div class="col text-end">

                <a href="{% url 'kardex:paciente_list' %}" class="btn btn-secondary btn-sm no-print">Cancelar</a>
                <button type="submit" class="btn btn-primary btn-sm no-print">Guardar</button>
            </div>
        </div>
    </form>
</div>


{% endblock %}

{% block javascript %}
<script>
    $('.select2').select2({
        theme: 'bootstrap4',
        width: '100%'
    });
</script>
<script src="{% static 'js/apis/api_select2_ficha.js' %}"></script>
<script src="{% static 'js/apis/api_select2_rut.js' %}"></script>
<script src="{% static 'js/apis/api_select2_codigo.js' %}"></script>
<script src="{% static 'js/apis/handle_fichas.js' %}"></script>
<script src="{% static 'js/fields_form_paciente.js' %}"></script>
<script src="{% static 'js/apis/api_select2_rut_inicial.js' %}"></script>
{% endblock %}
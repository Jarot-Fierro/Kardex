{% extends 'base.html' %}
{% load static %}

{% block title %}Salida de Fichas{% endblock %}

{% block content %}
<div class="container-fluid py-2 small-input">
    <div class="row">
        <div class="col-12">
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Filtros</h3>
                </div>
                <div class="card-body">
                    <form id="form-filtros" class="form" method="get">
                        <div class="form-row">
                            <div class="form-group col-md-3">
                                <label for="id_hora_inicio">{{ filter_form.hora_inicio.label }}</label>
                                {{ filter_form.hora_inicio }}
                            </div>
                            <div class="form-group col-md-3">
                                <label for="id_hora_termino">{{ filter_form.hora_termino.label }}</label>
                                {{ filter_form.hora_termino }}
                            </div>
                            <div class="form-group col-md-3">
                                <label for="id_servicio_clinico">{{ filter_form.servicio_clinico.label }}</label>
                                {{ filter_form.servicio_clinico }}
                            </div>
                            <div class="form-group col-md-3">
                                <label for="id_profesional">{{ filter_form.profesional.label }}</label>
                                {{ filter_form.profesional }}
                            </div>
                        </div>
                        <button class="btn btn-secondary" type="submit"><i class="fas fa-filter"></i> Aplicar filtros
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Registrar Salida de Ficha</h3>
                </div>
                <div class="card-body">
                    <form method="post" id="form-salida" class="form" novalidate>
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group col-md-3">
                                <label for="rut_mov">RUT</label>
                                <input type="text" id="rut_mov" class="form-control" placeholder="Ingrese RUT">
                            </div>
                            <div class="form-group col-md-3">
                                    {{ form.ficha }}
                                    <label class="form-check-label" for="ficha_ficha">
                                        {{ form.ficha.label }}
                                    </label>
                                    {% for error in form.ficha.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="form-group col-md-6">
                                <label for="nombre_mov">Nombre</label>
                                <input type="text" id="nombre_mov" class="form-control"
                                       placeholder="Nombre del paciente" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-4">
                                <div class="form-check mt-2">
                                    {{ form.fecha_salida }}
                                    <label class="form-check-label" for="fecha_salida_ficha">
                                        {{ form.fecha_salida.label }}
                                    </label>
                                    {% for error in form.fecha_salida.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-2">
                                    {{ form.servicio_clinico }}
                                    <label class="form-check-label" for="servicio_clinico_ficha">
                                        {{ form.servicio_clinico.label }}
                                    </label>
                                    {% for error in form.servicio_clinico.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-2">
                                    {{ form.profesional }}
                                    <label class="form-check-label" for="profesional_movimiento">
                                        {{ form.profesional.label }}
                                    </label>
                                    {% for error in form.profesional.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-12">
                                <div class="form-check mt-2">
                                    {{ form.observacion_salida }}
                                    <label class="form-check-label" for="observacion_salida_ficha">
                                        {{ form.observacion_salida.label }}
                                    </label>
                                    {% for error in form.observacion_salida.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <button type="submit" id="btn-registrar-salida" class="btn btn-primary"><i
                                class="fas fa-save"></i> Registrar salida
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Movimientos</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="tabla-mov" class="table table-striped table-hover table-sm" style="width:100%">
                            <thead>
                            <tr>
                                {% for c in view.datatable_columns %}
                                <th>{{ c }}</th>
                                {% endfor %}
                                <th></th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        function q(id) { return document.getElementById(id); }
        function selAll(selector) { return Array.prototype.slice.call(document.querySelectorAll(selector)); }
        const urlLookup = '{% url "kardex:api_movimiento_ficha_lookup" %}';

        // Campos mínimos para movimientos de fichas
        const inputRut = q('rut_mov');
        const inputNumFicha = q('ficha_mov');
        const campoNombre = q('nombre_mov');
        // Spans para fechas dinámicas
        const spanPacCreated = q('paciente_created_at_text');
        const spanPacUpdated = q('paciente_updated_at_text');
        const spanFichaCreated = q('ficha_created_at_text');
        const spanFichaUpdated = q('ficha_updated_at_text');

        function lockForm(lock) {
            const form = document.querySelector('form');
            if (!form) return;
            const elems = form.querySelectorAll('input, select, textarea, button');
            elems.forEach(el => {
                if (lock) { el.setAttribute('data-prev-disabled', el.disabled ? '1' : '0'); el.disabled = true; }
                else { /* no-op on unlock here; we will force-enable below */ el.removeAttribute('data-prev-disabled'); }
            });
        }
        function enableAllInputs() {
            const form = document.querySelector('form');
            if (!form) return;
            form.querySelectorAll('input, select, textarea, button').forEach(el => { el.disabled = false; });
        }

        function isoToDMY(iso) {
            // iso expected YYYY-MM-DD
            if (!iso) return '';
            const p = iso.split('-');
            if (p.length !== 3) return iso;
            return `${p[2]}/${p[1]}/${p[0]}`;
        }
        function isoToDMYHM(iso) {
            // expects ISO datetime or date; returns dd/mm/yyyy HH:MM
            if (!iso) return '';
            try {
                const d = new Date(iso);
                if (isNaN(d.getTime())) return iso;
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                const hh = String(d.getHours()).padStart(2, '0');
                const mi = String(d.getMinutes()).padStart(2, '0');
                return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
            } catch (e) {
                return iso;
            }
        }

        function fillForm(p) {
            // p is an item from results with rut, nombre_completo, numero_ficha
            if (!p) return;

            if (inputRut) inputRut.value = p.rut || '';
            if (inputNumFicha) inputNumFicha.value = p.numero_ficha || '';
            if (campoNombre) {
                campoNombre.value = p.nombre_completo || '';
                try { campoNombre.readOnly = true; } catch (e) {}
            }

            // No se usan otros campos en movimientos; sólo mostramos nombre.
        }



        async function doLookup(params) {
            const url = new URL(urlLookup, window.location.origin);
            Object.keys(params || {}).forEach(k => {
                if (params[k]) url.searchParams.set(k, params[k]);
            });
            try {
                lockForm(true);
                const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                const data = await resp.json();
                if (data && data.ok && Array.isArray(data.results) && data.results.length > 0) {
                    fillForm(data.results[0]);
                } else {
                    const msg = (data && (data.error || data.message)) || 'No se encontró el paciente/ficha.';
                    alert(msg);
                }
            } catch (e) {
                console.error(e);
                alert('Ocurrió un error realizando la búsqueda.');
            } finally {
                lockForm(false);
                enableAllInputs();
            }
        }

        function attach() {
            if (inputRut) {
                inputRut.addEventListener('blur', function () {
                    const v = (this.value || '').trim();
                    if (v) doLookup({ rut: v });
                });
                inputRut.addEventListener('change', function () {
                    const v = (this.value || '').trim();
                    if (v) doLookup({ rut: v });
                });
            }
            if (inputNumFicha) {
                inputNumFicha.addEventListener('blur', function () {
                    const v = (this.value || '').trim();
                    if (v) doLookup({ ficha: v });
                });
                inputNumFicha.addEventListener('change', function () {
                    const v = (this.value || '').trim();
                    if (v) doLookup({ ficha: v });
                });
            }
        }

        document.addEventListener('DOMContentLoaded', attach);
    })();
</script>

{% endblock %}

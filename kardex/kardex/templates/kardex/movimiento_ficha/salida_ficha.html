{% extends 'base.html' %}
{% load static %}

{% block title %}Salida de Fichas{% endblock %}

{% block content %}
<div class="container-fluid small-input">
    <div class="row">
        <div class="col-12">
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Filtros</h3>
                </div>
                <div class="card-body">
                    <form id="form-filtros" class="form" method="get">
                        <div class="form-row">
                            <div class="form-group col-md-3">
                                <label>{{ filter_form.hora_inicio.label }}</label>
                                {{ filter_form.hora_inicio }}
                            </div>
                            <div class="form-group col-md-3">
                                <label for="id_hora_termino">{{ filter_form.hora_termino.label }}</label>
                                {{ filter_form.hora_termino }}
                            </div>
                            <div class="form-group col-md-3">
                                <label for="id_servicio_clinico">{{ filter_form.servicio_clinico.label }}</label>
                                {{ filter_form.servicio_clinico }}
                            </div>
                            <div class="form-group col-md-3">
                                <label for="id_profesional">{{ filter_form.profesional.label }}</label>
                                {{ filter_form.profesional }}
                            </div>
                        </div>
                        <button class="btn btn-secondary" type="submit"><i class="fas fa-filter"></i> Aplicar filtros
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Registrar Salida de Ficha</h3>
                </div>
                <div class="card-body">
                    <form method="post" id="form-salida" class="form" novalidate>
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group col-md-3">
                                <label class="form-check-label" for="ficha_rut">
                                    {{ form.rut.label }}
                                </label>
                                {{ form.rut }}
                                {% for error in form.rut.errors %}
                                <span class="text-danger small d-block">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="form-group col-md-3">
                                <label class="form-check-label" for="ficha_ficha">
                                    {{ form.ficha.label }}
                                </label>
                                {{ form.ficha }}
                                {% for error in form.ficha.errors %}
                                <span class="text-danger small d-block">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="form-group col-md-6">
                                <label class="form-check-label" for="ficha_nombre">
                                    {{ form.nombre.label }}
                                </label>
                                {{ form.nombre }}
                                {% for error in form.nombre.errors %}
                                <span class="text-danger small d-block">{{ error }}</span>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <label class="form-check-label" for="fecha_salida_ficha">
                                        {{ form.fecha_envio.label }}
                                    </label>
                                    {{ form.fecha_envio }}
                                    {% for error in form.fecha_envio.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <label class="form-check-label" for="servicio_clinico_ficha">
                                        {{ form.servicio_clinico_envio.label }}
                                    </label>
                                    {{ form.servicio_clinico_envio }}

                                    {% for error in form.servicio_clinico_envio.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <label class="form-check-label" for="servicio_clinico_recepcion">
                                        {{ form.servicio_clinico_recepcion.label }}
                                    </label>
                                    {{ form.servicio_clinico_recepcion }}
                                    {% for error in form.servicio_clinico_recepcion.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <label class="form-check-label" for="profesional_movimiento">
                                        {{ form.profesional_envio.label }}
                                    </label>
                                    {{ form.profesional_envio }}
                                    {% for error in form.profesional_envio.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <label class="form-check-label" for="observacion_envio_ficha">
                                        {{ form.observacion_envio.label }}
                                    </label>
                                    {{ form.observacion_envio }}
                                    {% for error in form.observacion_envio.errors %}
                                    <span class="text-danger small d-block">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <button type="submit" id="btn-registrar-salida" class="btn btn-primary mt-3"><i
                                class="fas fa-save"></i> Registrar salida
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Movimientos de Salida</h3>
                </div>
                <div class="card-body">
                    <table id="Table" class="table table-bordered table-striped table-sm">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Acciones</th>
                            {% for col in columns %}
                            {% if col != 'ID' %}
                            <th>{{ col }}</th>
                            {% endif %}
                            {% endfor %}
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block javascript %}
<script>
    $('.select2').select2({
        theme: 'bootstrap4',
        width: '100%'
    });
</script>
<script src="{% static 'js/apis/handle_fichas_salida_mov.js' %}"></script>
<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    var form = document.getElementById('form-salida');
    if(!form) return;
    var rutEl = document.getElementById('id_rut');
    var fichaEl = document.getElementById('id_ficha');

    var apiOK = false;
    var lastCargaTs = 0;

    // Marca cuando la API terminó de cargar la ficha
    window.addEventListener('salidaFichaCargada', function(e){
      apiOK = true;
      lastCargaTs = Date.now();
      try { window.__ultimaFichaCargadaId = (e && e.detail && e.detail.fichaId) || null; } catch(_) { /* noop */ }
    });

    function fetchByRutOrFicha(){
      var base = 'http://127.0.0.1:8000/api/ingreso-paciente-ficha/';
      var search = '';
      var tipo = '';
      var rut = rutEl && rutEl.value ? String(rutEl.value).trim() : '';
      var ficha = fichaEl && fichaEl.value ? String(fichaEl.value).trim() : '';

      if(rut){
        search = rut; tipo = 'rut';
      } else if(ficha){
        var normalized = ficha.replace(/^0+/, '');
        search = normalized || ficha;
        tipo = 'ficha';
      } else {
        return Promise.reject(new Error('Debe ingresar RUT o Ficha antes de enviar.'));
      }

      var params = new URLSearchParams({ search: search, tipo: tipo });
      return fetch(base + '?' + params.toString(), { headers: { 'Accept': 'application/json' }})
        .then(function(res){ return res.json().catch(function(){ return {}; }); })
        .then(function(data){
          var items = Array.isArray(data) ? data : (data.results || []);
          if(Array.isArray(items) && items.length){
            var first = items[0];
            if(first && typeof first.id !== 'undefined' && typeof window.cargarDatosSalidaFicha === 'function'){
              window.cargarDatosSalidaFicha(first.id);
              return true;
            }
          }
          throw new Error('No se encontró ficha para los datos ingresados.');
        });
    }

    // Intercepta el submit para garantizar que la API se consuma antes de enviar
    form.addEventListener('submit', function(e){
      var recentlyLoaded = apiOK && (Date.now() - lastCargaTs) < 1500; // ventana corta de validez
      if(recentlyLoaded){
        return; // permitir submit natural
      }
      e.preventDefault();
      e.stopPropagation();

      fetchByRutOrFicha()
        .then(function(){
          // Esperar confirmación de carga; fallback por timeout
          var timeout = setTimeout(function(){ try { form.submit(); } catch(_){} }, 800);
          var once = function(){
            try { clearTimeout(timeout); } catch(_){ }
            window.removeEventListener('salidaFichaCargada', once);
            setTimeout(function(){ try { form.submit(); } catch(_){ } }, 10);
          };
          window.addEventListener('salidaFichaCargada', once);
        })
        .catch(function(err){
          console.warn('[salida_ficha][guard] Error antes de enviar:', err);
          alert(err && err.message ? err.message : 'Error consultando la API antes de enviar.');
        });
    }, true);
  });
})();
</script>
{% endblock %}
